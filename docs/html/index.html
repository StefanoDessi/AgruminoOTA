<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AgruminoOTA: AgruminoOTA</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AgruminoOTA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="class_agrumino_o_t_a.html">AgruminoOTA (Link for class documentation)</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Introduction</h2>
<p>OTA (Over the Air) update is the process of loading the firmware to ESP module using Wi-Fi connection. This library has the goal of bringing OTA functionalities to the Agrumino board.</p>
<p>OTA may be done using several modes:</p><ul>
<li><a href="#http-server">HTTP Server</a></li>
<li><a href="#arduinoide">ArduinoIDE</a></li>
<li><a href="#web-browser">Web Browser</a></li>
</ul>
<p>All of the aforementioned methods need an existing network connection, additional functions to establish a Wi-Fi connection and check the connection status have been included in this library.</p>
<p>The new sketch will be stored in the space between the old sketch and the spiff, the new sketch is then copied over the old one after a board reset. This means that after an upload is sucessfully completed the board will always require a reboot to complete the process and begin running the new sketch.</p>
<p>In order to keep OTA functionalities the new sketches will require some way to activate OTA routines again.</p>
<p>OTA methods are static so they can be called in two equivalent ways: </p><div class="fragment"><div class="line">{c++}</div><div class="line">AgruminoOTA agruminoOTA;</div><div class="line">agruminoOTA.isConnected(); //Using class instance</div><div class="line">AgruminoOTA::isConnected(); //Using class name</div></div><!-- fragment --> <h2>HTTP Server</h2>
<p>This mode consist of a direct download of a binary image from a specified IP or domain address on the network or Internet. </p><div class="fragment"><div class="line">{c++}</div><div class="line">static void httpUpdate(Agrumino agrumino, const char* ota_server,int ota_port,const char* ota_path);</div><div class="line">static void httpUpdate(Agrumino agrumino, const char* ota_server, int ota_port, const char* ota_path, const char* ota_version_string);</div></div><!-- fragment --><p> The hosting server may handle the download request in an advanced way using the headers sent in the HTTP request.</p>
<p>Example of header data: </p><div class="fragment"><div class="line">[HTTP_USER_AGENT] =&gt; ESP8266-http-Update</div><div class="line">[HTTP_X_ESP8266_STA_MAC] =&gt; 18:FE:AA:AA:AA:AA</div><div class="line">[HTTP_X_ESP8266_AP_MAC] =&gt; 1A:FE:AA:AA:AA:AA</div><div class="line">[HTTP_X_ESP8266_FREE_SPACE] =&gt; 671744</div><div class="line">[HTTP_X_ESP8266_SKETCH_SIZE] =&gt; 373940</div><div class="line">[HTTP_X_ESP8266_SKETCH_MD5] =&gt; a56f8ef78a0bebd812f62067daf1408a</div><div class="line">[HTTP_X_ESP8266_CHIP_SIZE] =&gt; 4194304</div><div class="line">[HTTP_X_ESP8266_SDK_VERSION] =&gt; 1.3.0</div><div class="line">[HTTP_X_ESP8266_VERSION] =&gt; DOOR-7-g14f53a19</div></div><!-- fragment --><p> The parameter ota_version_string is optional and corresponds to the HTTP_X_ESP8266_VERSION header. The server can use header information to check if an update is needed. It is also possible to deliver different binaries based on the MAC address for example.</p>
<h2>ArduinoIDE</h2>
<p>This mode requires python 2.7 and handles updates done using Arduino IDE, or even directly with a console python command. In Arduino IDE (you may need to restart the IDE first) the board will appear as Agrumino-[ChipID] in Tools -&gt; Port -&gt; Network ports. </p><div class="fragment"><div class="line">{c++}</div><div class="line">static void otaUpdate(Agrumino agrumino);</div><div class="line">static void otaUpdate(Agrumino agrumino, const char* password);</div></div><!-- fragment --><p> A password can be specified, but it should be noted that it's possible to reveal a password entered previously in Arduino IDE, if the IDE has not been closed since last upload.</p>
<p>The ArduinoIDE mode requires the device to enter a loop in order to handle the reception of updates, to exit from this loop press the user button.</p>
<h2>Web Browser</h2>
<p>This mode uses a web site hosted by the board to handle the upload of a binary image containing the new sketch. When the mode is activated an url (decided by the host parameter) is provided by the board using the serial monitor, if the url does not work, you can replace it with the moduleâ€™s IP address.</p>
<p>The hosted web site can be customized by the developers.</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">static void webServer(Agrumino agrumino,const char* host, int ota_port);</div></div><!-- fragment --><p> The Web Browser mode requires the device to enter a loop in order to handle the web browser, to exit from this loop press the user button. </p><h2>Safety and Security</h2>
<p>Security functions can be provided by server side checks in case of HTTP Server mode or the use of a password in Arduino IDE mode. </p><div class="fragment"><div class="line">{c++}</div><div class="line">static void OTAModeStart(Agrumino agrumino)</div></div><!-- fragment --><p> The function OTAModeStart() is called when any OTA mode is activated, inside this function some of the equipment can be put into a safe state before the update is performed.</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">ESP.getFreeSketchSpace();</div></div><!-- fragment --><p> Can be used to check the amount of free space for the new sketch.</p>
<p>The led will blink thrice in a short amount of time to signal the beginning of OTA mode.</p>
<h2>Example</h2>
<p>An example skeleton sketch has been written handling various OTA cases, changing the defined value OTA_TYPE will result in the use of a different mode:</p><ul>
<li>1 - HTTP Server</li>
<li>2 - Web Browser</li>
<li>3 - IDE update</li>
<li>4 - IDE update with password</li>
</ul>
<p>The selected mode is activated by pressing the user button for a certain amount of time, an amount specified by the defined value pressInterval (set to 3 seconds by default).</p>
<p>When the button has been pressed for the specified amount of time the board will try to connect to the specified network a certain number of times (defined by WI_FI_FAILED_TRIES_MAX).</p>
<p>In case of a mode that requires entering a loop to handle the update (Web Browser and IDE update) if the user button is pressed once more the program will exit the loop.</p>
<p>Values required by the sketch to connect to a network and handle the selected OTA mode need to be filled out before compiling.</p>
<h2>Documentation for further expansion</h2>
<ul>
<li><a href="https://github.com/esp8266/Arduino/blob/master/doc/ota_updates/readme.rst">ArduinoOTA documentation (used to develop this library)</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
